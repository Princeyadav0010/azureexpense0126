# Azure DevOps Pipeline Configuration
# Alternative to GitHub Actions for Azure-native CI/CD

trigger:
  branches:
    include:
    - main
    - master
  paths:
    include:
    - backend-simple/*

variables:
  azureSubscription: 'Azure-Service-Connection'  # Azure DevOps में service connection का name
  webAppName: 'expense-backend-app'
  containerRegistry: 'expensetracker.azurecr.io'
  imageRepository: 'expense-backend'
  dockerfilePath: 'backend-simple/dockerfile'
  tag: '$(Build.BuildId)'
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and Push Docker Image
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build Docker Image
      inputs:
        command: build
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(containerRegistry)
        tags: |
          $(tag)
          latest

    - task: Docker@2
      displayName: Push Docker Image to ACR
      inputs:
        command: push
        repository: $(imageRepository)
        containerRegistry: $(containerRegistry)
        tags: |
          $(tag)
          latest

- stage: Deploy
  displayName: Deploy to Azure Web App
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: Deploy
    environment: 'production'
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebAppContainer@1
            displayName: Deploy to Azure Web App
            inputs:
              azureSubscription: $(azureSubscription)
              appName: $(webAppName)
              containers: $(containerRegistry)/$(imageRepository):$(tag)

          - task: AzureAppServiceSettings@1
            displayName: Configure App Settings
            inputs:
              azureSubscription: $(azureSubscription)
              appName: $(webAppName)
              resourceGroupName: 'expense-tracker-rg'
              appSettings: |
                [
                  {
                    "name": "COSMOS_DB_ENDPOINT",
                    "value": "$(COSMOS_DB_ENDPOINT)",
                    "slotSetting": false
                  },
                  {
                    "name": "COSMOS_DB_KEY",
                    "value": "$(COSMOS_DB_KEY)",
                    "slotSetting": false
                  },
                  {
                    "name": "COSMOS_DB_DATABASE_NAME",
                    "value": "ExpenseTrackerDB",
                    "slotSetting": false
                  },
                  {
                    "name": "NODE_ENV",
                    "value": "production",
                    "slotSetting": false
                  }
                ]
